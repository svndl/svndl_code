function elp2png

[elpFile,elpPath] = uigetfile('*.elp','Pick a Polhemus elp-file');
if isnumeric(elpFile)
	return
end

% --------------------- read elpFile -----------------------------

fid = fopen([elpPath,elpFile],'r');
% read prolog
textscan(fid,'%n',3,'commentstyle','//');
% read header
c = textscan(fid,'%s',2,'commentstyle','//');
if strcmp(c{1}{1},'%N')
	c = textscan(fid,'%n',2,'commentstyle','//');
	ne = c{1}(2);
else
	ne = eval(c{1}{2});
end
% check for anatomical fiducials
c = textscan(fid,'%s',1,'commentstyle','//');
anat = [];
while strcmp(c{1},'%F')
	c = textscan(fid,'%n',3,'commentstyle','//');
	anat = [anat; c{1}'];		% presumably [ NZx NZy NZz; LAx LAy LAz; RAx RAy RAz ]
	c = textscan(fid,'%s',1,'commentstyle','//');
end
name = cell(ne,1);
pos3D = zeros(ne,3);		% position (m), orientation
i = 0;
while strcmp(c{1},'%S')
	i = i+1;
	% read Type Code
	textscan(fid,'%s',1,'commentstyle','//');
	fpos = ftell(fid);
	% check for Name [optional]
	c = textscan(fid,'%s',2,'commentstyle','//');
	if strcmp(c{1}{1},'%N')
		name{i} = c{1}{2};
	else
		fseek(fid,fpos,-1);
	end
	fpos = ftell(fid);
	% check for "sphere origin" ???not in spec???
	c = textscan(fid,'%s',1,'commentstyle','//');
	if strcmp(c{1}{1},'%O')
		textscan(fid,'%n',3,'commentstyle','//');
	else
		fseek(fid,fpos,-1);
	end
	% read electrode position
	c = textscan(fid,'%n',3,'commentstyle','//');
	pos3D(i,1:3) = c{1}(:)';
	% check for orientation???

	% look for next electrode
	c = textscan(fid,'%s',1,'commentstyle','//');
	if isempty(c{1})
		fclose(fid);
		break
	end
end	



% transform ALS to RAS
if true		% use fiducials such that LA on -X, RA on +X, & NZ on +Y axes
	r = hypot( anat(2,1), anat(2,2) );
	cosa = -anat(2,1) / r;		% -sin(a-pi/2)
	sina =  anat(2,2) / r;		%  cos(a-pi/2)
	pos3D(:,1:2) = [ pos3D(:,1)*cosa - pos3D(:,2)*sina - anat(1,1)*cosa, pos3D(:,1)*sina + pos3D(:,2)*cosa ];
% 	anat(:,1:2)  = [  anat(:,1)*cosa -  anat(:,2)*sina - anat(1,1)*cosa,  anat(:,1)*sina +  anat(:,2)*cosa ];
else			% no rotations, just swap 1st 2 dimensions & flip LR
	pos3D(:,1:2) = [-pos3D(:,2),pos3D(:,1)];
end


% ------------------------- sort electrodes --------------------------------------

% expecting REF electrode (name='400') first,
% then 1-128 (name='#')
% sort (put ref @ end)
[junk,k] = sort(cellfun(@eval,name));
pos3D  = pos3D(k,:);


%--------------------------------- flatten ---------------------------------------

eFlat = 0.6;		% flattening exponent
pos3D = pos3D - repmat( fminsearch(@originFcn,median(pos3D)), ne, 1 );			% remove best-fitting sphere origin
[pos3D(:,1),pos3D(:,2)] = cart2sph( pos3D(:,1), pos3D(:,2), pos3D(:,3) );
pos2D = zeros(ne,2);
[pos2D(:,1),pos2D(:,2)] = pol2cart( pos3D(:,1), (1-sin(pos3D(:,2))).^eFlat );

	function fval = originFcn(o)
		dp = pos3D - repmat(o,ne,1);
		u = dp ./ repmat( hypot( hypot( dp(:,1), dp(:,2) ), dp(:,3) ), 1, 3 );
		fval = norm(u*(u(:)\dp(:))-dp,'fro');
	end

%------------------------------fixed face matrix----------------------------------

% if includeRef
% 	Finit = [ 129 7 31; 129 106 7; 129 80 106; 129 55 80; 129 31 55 ];
% else
% 	Finit = [ 31 55 7; 7 55 106; 106 55 80 ];
% end

EGI = [ 129 7 31;...
		129 106 7;...
		129 80 106;...
		129 55 80;...
		129 31 55;...
		7 106 6;...
		106 80 105;...
		80 55 79;...
		55 31 54;...
		31 7 30;...
		6 106 112;...
		112 106 105;...
		105 80 87;...
		80 79 87;...
		79 55 54;...
		79 54 62;...
		54 31 37;...
		37 31 30;...
		30 7 13;...
		13 7 6;...
		13 6 12;...
		6 112 5;...
		112 105 111;...
		105 87 104;...
		87 79 86;...
		79 62 78;...
		62 54 61;...
		54 37 53;...
		37 30 36;...
		30 13 29;...
		6 5 12;...
		112 118 5;...
		112 111 118;...
		111 105 104;...
		104 87 93;...
		93 87 86;...
		86 79 78;...
		61 54 53;...
		53 37 42;...
		42 37 36;...
		36 30 29;...
		29 13 20;...
		20 13 12;...
		12 5 11;...
		5 118 4;...
		118 111 117;...
		111 104 110;...
		104 93 103;...
		93 86 92;...
		86 78 85;...
		78 62 77;...
		62 61 67;...
		61 53 60;...
		53 42 52;...
		42 36 41;...
		36 29 35;...
		29 20 28;...
		20 12 19;...
		5 4 11;...
		118 124 4;...
		118 117 124;...
		117 111 110;...
		110 104 103;...
		103 93 98;...
		98 93 92;...
		92 86 85;...
		85 78 77;...
		77 62 72;...
		72 62 67;...
		67 61 60;...
		60 53 52;...
		52 42 47;...
		47 42 41;...
		41 36 35;...
		35 29 28;...
		28 20 24;...
		24 20 19;...
		19 12 11;...
		11 4 10;...
		4 124 3;...
		124 117 123;...
		117 110 116;...
		110 103 109;...
		103 98 102;...
		98 92 97;...
		92 85 91;...
		85 77 84;...
		77 72 76;...
		72 67 71;...
		67 60 66;...
		60 52 59;...
		52 47 51;...
		47 41 46;...
		41 35 40;...
		35 28 34;...
		28 24 27;...
		24 19 23;...
		19 11 18;...
		11 10 16;...
		10 4 3;...
		3 124 123;...
		123 117 116;...
		116 110 109;...
		109 103 102;...
		102 98 97;...
		97 92 91;...
		91 85 84;...
		84 77 76;...
		76 72 71;...
		71 67 66;...
		66 60 59;...
		59 52 51;...
		51 47 46;...
		46 41 40;...
		40 35 34;...
		34 28 27;...
		27 24 23;...
		23 19 18;...
		18 11 16;...
		16 10 15;...
		10 3 9;...
		3 123 2;...
		123 116 122;...
		116 109 115;...
		109 102 108;...
		102 97 101;...
		97 91 96;...
		91 84 90;...
		84 76 83;...
		76 71 75;...
		71 66 70;...
		66 59 65;...
		59 51 58;...
		51 46 50;...
		46 40 45;...
		40 34 39;...
		34 27 33;...
		27 23 26;...
		23 18 22;...
		18 16 15;...
		15 10 9;...
		9 3 2;...
		2 123 122;...
		122 116 115;...
		115 109 108;...
		108 102 101;...
		101 97 96;...
		96 91 90;...
		90 84 83;...
		83 76 75;...
		75 71 70;...
		70 66 65;...
		65 59 58;...
		58 51 50;...
		50 46 45;...
		45 40 39;...
		39 34 33;...
		33 27 26;...
		26 23 22;...
		22 18 15;...
		15 9 14;...
		9 2 8;...
		2 122 1;...
		122 115 121;...
		115 108 114;...
		101 96 100;...
		96 90 95;...
		90 83 89;...
		83 75 82;...
		75 70 74;...
		70 65 69;...
		65 58 64;...
		58 50 57;...
		45 39 44;...
		39 33 38;...
		33 26 32;...
		26 22 25;...
		22 15 21;...
		21 15 14;...
		14 9 8;...
		8 2 1;...
		1 122 121;...
		121 115 114;...
		100 96 95;...
		100 95 99;...
		95 90 89;...
		95 89 94;...
		89 83 82;...
		89 82 88;...
		82 75 74;...
		82 74 81;...
		74 70 69;...
		74 69 73;...
		69 65 64;...
		69 64 68;...
		64 58 57;...
		64 57 63;...
		44 39 38;...
		38 33 32;...
		32 26 25;...
		25 22 21;...
		21 14 17;...
		1 121 125;...
		121 114 120;...
		114 108 113;...
		100 99 107;...
		63 57 56;...
		45 44 49;...
		44 38 43;...
		38 32 128;...
		120 114 113;...
		120 113 119;...
		49 44 43;...
		49 43 48;...
		125 121 120;...
		125 120 119;...
		108 101 100;...
		108 100 107;...
		113 108 107;...
		99 95 94;...
		94 89 88;...
		88 82 81;...
		81 74 73;...
		73 69 68;...
		68 64 63;...
		57 50 45;...
		57 45 56;...
		56 45 49;...
		43 38 128;...
		43 128 48;...
		125 119 126;...
		48 128 127];


%------------------------------- plot --------------------------------------------
WH = 650;		% width,height (pixels)
pMin = min(pos2D);
pMax = max(pos2D);

fig = figure('units','pixels','position',[50 80 WH+[4 4]],'color','w','menubar','none');
ax = axes('units','pixels','position',[2 2 WH WH],'dataaspectratio',[1 1 1],'visible','off','xtick',[],'ytick',[],'ztick',[],...
			'xlim',pMin(1)+(pMax(1)-pMin(1))*[-0.05 1.05],'ylim',pMin(2)+(pMax(2)-pMin(2))*[-0.05 1.05]);
% mesh
patch('vertices',[pos2D,zeros(ne,1)],'faces',EGI,'facecolor','w','edgecolor',[0 0 0]+0.75,'linewidth',1)
% lines
c = [1 0.75 0];
w = 2;
k = 1:7;			line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
k = 8:13;		line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
k = 14:16;		line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
k = 17:20;		line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
k = 21:24;		line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
k = 25:31;		line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
k = 32:37;		line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
k = 38:42;		line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
k = 43:47;		line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
k = 48:55;		line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
k = 56:62;		line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
k = 63:67;		line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
k = 68:72;		line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
k = 73:80;		line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
k = 81:87;		line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
k = 88:93;		line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
k = 94:98;		line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
k = 99:106;		line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
k = 107:112;	line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
k = 113:118;	line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
k = 119:124;	line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
% k = 125:126;	line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
% k = 127:128;	line(pos2D(k,1),pos2D(k,2),'linewidth',w,'color',c)
% labels
T = zeros(1,128);
for i = 1:numel(T)
	T(i) = text(pos2D(i,1),pos2D(i,2),int2str(i));
end
set(T,'horizontalalignment','center','verticalalignment','middle',...
	'fontname','Arial','fontsize',12,'fontweight','bold','color',[0 0 0])


%---------------------- write image --------------------------------

F = getframe(ax);
[pngPath,pngFile] = fileparts([elpPath,elpFile]);
imwrite(F.cdata,fullfile(pngPath,[pngFile,'.png']),'png')
% close(fig)

end

